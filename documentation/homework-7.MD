# –û–ø–µ—Ä–∞—Ç–æ—Ä—ã, CustomResourceDefinition

–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ7  
–í—ã–ø–æ–ª–Ω–∏–ª –±–∞–∑—É + üêç python KOPF –ª–æ–≥–∏–∫—É. –¢–∞–∫–∂–µ –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ üåü  

---  
<br>  

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞  
–°–æ–∑–¥–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ —Å –¥–æ–º–∞—à–∏–º –∑–∞–¥–∞–Ω–∏–µ–º (/kubernetes-controllers):  
.  
‚îú‚îÄ‚îÄ build  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ Dockerfile  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mysql-operator.py  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îî‚îÄ‚îÄ templates  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ backup-job.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ backup-pvc.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ backup-pv.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mysql-deployment.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mysql-pvc.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mysql-pv.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mysql-service.yml.j2  
‚îÇ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚îî‚îÄ‚îÄ restore-job.yml.j2  
‚îî‚îÄ‚îÄ deploy  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ crd.yml  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ cr.yml  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ deploy-operator.yml  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ role-binding.yml  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ role.yml  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ service-account.yml  


–°–æ–≥–ª–∞—Å–Ω–æ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É–∫–∞–∑–∞–Ω–∏–π –Ω–∞–ø–æ–ª–Ω–∏–ª —Ñ–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∏–º—ã–º c —É—á–µ—Ç–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π `apiVersion`, –∑–∞–ø—É—Å—Ç–∏–ª `minikube`  

---
<br>  

## –ó–∞–¥–∞–Ω–∏–µ –ø–æ CRD  
> "–ï—Å–ª–∏ —Å–µ–π—á–∞—Å –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è mysql —É–±—Ä–∞—Ç—å —Å—Ç—Ä–æ—á–∫—É –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, —Ç–æ
–º–∞–Ω–∏—Ñ–µ—Å—Ç –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç API —Å–µ—Ä–≤–µ—Ä–æ–º. –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å,
–¥–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–ª–µ–π –≤ CustomResourceDefinition"

–î–æ–±–∞–≤–∏–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –æ–ø–∏—Å–∞–Ω–∏–µ [CRD](/kubernetes-operators/deploy/crd.yml):  
```yaml
...
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                database:
                  type: string
                  description: database name
                image:
                  type: string
                  description: image for MySQL
                password:
                  type: string
                  description: password for DB
                storage_size:
                  type: string
                  description: storage size
              required:
              - image
              - database
              - password
              - storage_size
...
```  

---
<br>  

## –û–ø–µ—Ä–∞—Ç–æ—Ä—ã
–†–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞–ª –Ω–∞ üêç –ø–æ –æ–±—Ä–∞–∑—Ü—É –∏–∑ –º–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏—Ö —É–∫–∞–∑–∞–Ω–∏–π —Å –¥–æ—Ä–∞–±–æ—Ç–∫–æ–π.  
–ò—Å—Ö–æ–¥–Ω–∏–∫: [mysql-operator.py](/kubernetes-operators/build/mysql-operator.py)  
–ì–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ DockerHub:  
```bash
$ docker pull shamrockoo4tune/mysqloperator:v1.1
```  
–ü—Ä–∏–º–µ–Ω–∏–ª –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã [crd.yml](/kubernetes-operators/deploy/crd.yml) –∏ [cr.yml](/kubernetes-operators/deploy/cr.yml), –ø–æ—Å–ª–µ –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä:  
![img 1.png placeholder](/documentation/img/hw-7/1.png)  

> "–í–æ–ø—Ä–æ—Å: –ø–æ—á–µ–º—É –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–ª—Å—è, —Ö–æ—Ç—è –º—ã —Å–æ–∑–¥–∞–ª–∏ CR, –¥–æ —Ç–æ–≥–æ, –∫–∞–∫
–∑–∞–ø—É—Å—Ç–∏–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä?"

> "–û—Ç–≤–µ—Ç: –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –∏—â–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –µ–º—É –æ–±—ä–µ–∫—Ç—ã  ('otus.homework', 'v1', 'mysqls') —á–µ—Ä–µ–∑ API —Å–µ—Ä–≤–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–≤–æ–∏—Ö –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤. –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–Ω–µ–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é: `[default/mysql-instance] Patching with: {'metadata': {'finalizers': ['kopf.zalando.org/KopfFinalizerMarker']}}`"  

---
<br>  

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞  
1. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ë–î —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
2. –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ MySQL
3. –ü—Ä–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è pv —Ä–µ—Å—É—Ä—Å–∞
4. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ MySQL
5. –û–∂–∏–¥–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î –∏–∑ –±—ç–∫–∞–ø–∞
![img 2.png placeholder](/documentation/img/hw-7/2.png)  

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–µ, –∑–∞–ø—É—â–µ–Ω–Ω—ã–º —á–µ—Ä–µ–∑ deployment:  
![img 3.png placeholder](/documentation/img/hw-7/3.png)  

---
<br>  

## üêç –ó–∞–¥–∞–Ω–∏–µ —Å–æ üåü (1)

–í –∫–æ–¥–µ [–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞](/kubernetes-operators/build/mysql-operator.py) –¥–æ–±–∞–≤–∏–ª –≤—ã–≤–æ–¥ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `message` –≤ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `mysql_on_create`:  
```py
return {'Message': message}
```  
`kopf` –±—É–¥–µ—Ç —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ `Status` –æ–±—ä–µ–∫—Ç–∞ –ª—é–±–æ–π `return` –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º –¥–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

`message` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ —Ä–µ–∑—É–ª—å–∞—Ç –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∂–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞ –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ:  
```py
    # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏–∑ backup
    api = kubernetes.client.BatchV1Api()
    try:
        api.create_namespaced_job('default', restore_job)
        message = 'mysql-instance created with restore-job'
    except kubernetes.client.rest.ApiException:
        message = 'mysql-instance created without restore-job'
        pass
```  
–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ `Status` —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ mysql:  
![img 4.png placeholder](/documentation/img/hw-7/4.png) 

---
<br>  

## üêç –ó–∞–¥–∞–Ω–∏–µ —Å–æ üåü (2)

–ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. 
–ó–∞–º–µ–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –≤ —Ç–µ–º–ø–ª—ç–π—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –Ω–æ —Å–∞–º –∏–Ω—Å—Ç–∞–Ω—Å mysql –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å—Ç–∞—Ä—ã–º.

–†–µ–∞–ª–∏–∑–æ–≤–∞–ª –≤ –∫–æ–¥–µ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@kopf.on.update`:  
```py
@kopf.on.update('otus.homework', 'v1', 'mysqls')
# –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —Ç–∏–ø–∞ MySQL:
def mysql_on_update_password(body, spec, status, **kwargs):
    password = spec.get('password', None)
    if not password:
        raise kopf.PermanentError(f"Password must be set. Got {password!r}.")
    name = status['mysql_on_create']['mysql-name']
    image = body['spec']['image']
    database = body['spec']['database']
    
    deployment = render_template(
        'mysql-deployment.yml.j2',
        {
            'name': name,
            'image': image,
            'password': password,
            'database': database
        }
    )

    api = kubernetes.client.AppsV1Api()
    obj = api.patch_namespaced_deployment(name=name, namespace='default', body=deployment)

    logging.info(f"MySQL deployment child is updated: {obj}")
```

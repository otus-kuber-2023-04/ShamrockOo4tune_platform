# –î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ ‚Ññ6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ k8s

## –°–±–æ—Ä–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞  

–û–±—Ä–∞–∑ —Å–æ–±–∏—Ä–∞–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –î–ó ‚Ññ2.  
–î–æ–±–∞–≤–∏–ª –∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ location basic_status  
–°–æ–±–∏—Ä–∞–ª –æ–±—Ä–∞–∑ –∫–æ–º–∞–Ω–¥–æ–π —Å —Ç–∞–∫–∏–º —Ç—ç–≥–æ–º:  
```bash
docker build -t shamrockoo4tune/otus_k8s_hw1:v0.0.3 ./kubernetes-monitoring/image/
```
–ò —Ä–∞–∑–º–µ—Å—Ç–∏–ª –≤ dockerhub —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ  

---  
<br>  

## –ö–ª–∞—Å—Ç–µ—Ä
```bash
anduser@shamil:~/ShamrockOo4tune_platform$ kind create cluster --config ./.ignore/kind.yml 
Creating cluster "kind" ...
 ‚úì Ensuring node image (kindest/node:v1.26.3) üñº
 ‚úì Preparing nodes üì¶ üì¶ üì¶ üì¶  
 ‚úì Writing configuration üìú 
 ‚úì Starting control-plane üïπÔ∏è 
 ‚úì Installing CNI üîå 
 ‚úì Installing StorageClass üíæ 
 ‚úì Joining worker nodes üöú 
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Thanks for using kind! üòä
```

---  
<br>  

## –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

–ß–µ—Ä–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å–æ–≤ [deployment-nginx.yaml](/kubernetes-monitoring/deployment-nginx.yaml) –∏ [svc-nginx.yaml](/kubernetes-monitoring/svc-nginx.yaml)  
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ deployment –∏ svc —á–µ—Ä–µ–∑ kubernetes-port-forwarder  
![1.png placeholder](/documentation/img/hw-6/1.png)  

```bash
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/deployment-nginx.yaml 
deployment.apps/nginx created
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/svc-nginx.yaml 
service/nginx created
```
---  
<br>  

## –ó–∞–ø—É—Å–∫ nginx-prometheus-exporter

–í –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –º–µ—Ç—Ä–∏–∫ - –ø–æ **–∏–º–µ–Ω–∏:–ø–æ—Ä—Ç—É** [—Å–µ—Ä–≤–∏—Å–∞ nginx](/kubernetes-monitoring/svc-nginx.yaml)   
```bash
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/deployment-exporter.yaml 
deployment.apps/nginx-prometheus-exporter created
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/svc-exporter.yaml 
service/nginx-prometheus-exporter created
```
---  
<br>  

## Prometheus operator
–ü—Ä–∏–º–µ–Ω–∏–ª –º–∞–Ω–∏—Ñ–µ—Å—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è prometheus operator –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ [–° –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞](https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md)

```bash
anduser@shamil:~/ShamrockOo4tune_platform$ LATEST=$(curl -s https://api.github.com/repos/prometheus-operator/prometheus-operator/releases/latest | jq -cr .tag_name)
prometheus-operator/prometheus-operator/releases/download/${LATEST}/bundle.yaml | kubectl create -f -anduser@shamil:~/ShamrockOo4tune_platform$ curl -sL https://github.com/prometheus-operator/prometheus-operator/releases/download/${LATEST}/bundle.yaml | kubectl create -f -
customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/prometheusagents.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/scrapeconfigs.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created
clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator created
clusterrole.rbac.authorization.k8s.io/prometheus-operator created
deployment.apps/prometheus-operator created
serviceaccount/prometheus-operator created
service/prometheus-operator created
anduser@shamil:~/ShamrockOo4tune_platform$ kubectl wait --for=condition=Ready pods -l  app.kubernetes.io/name=prometheus-operator -n default
pod/prometheus-operator-6b8d85bc4c-5t4ph condition met
```
---  
<br>  

## –û–±—ä–µ–∫—Ç service monitor  

–ù–∞—Ç—Ä–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ —è—Ä–ª—ã–∫–∞–º —Å–µ—Ä–≤–∏—Å–∞  
```bash
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/service-monitor.yaml 
servicemonitor.monitoring.coreos.com/nginx-prometheus-exporter created
```
---  
<br>  

## –£—Å—Ç–∞–Ω–æ–≤–∏–ª –æ–±—ä–µ–∫—Ç—ã prometheus  

```bash
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/prometheus.yaml 
serviceaccount/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
prometheus.monitoring.coreos.com/prometheus created
service/prometheus created
```
![4.png placeholder](/documentation/img/hw-6/4.png)  

---  
<br>  

## Grafana, port-forwarder  
```bash
anduser@shamil:~/ShamrockOo4tune_platform$ k apply -f ./kubernetes-monitoring/grafana.yaml 
persistentvolumeclaim/grafana-pvc created
deployment.apps/grafana created
service/grafana created
```

–í UI Grafana —É–∫–∞–∑–∞–ª url –ø–æ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞:–ø–æ—Ä—Ç—É **http://prometheus:9090**  
–£—Å—Ç–∞–Ω–æ–≤–∏–ª [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥—ç—à–±–æ—Ä–¥](https://grafana.com/grafana/dashboards/12708-nginx/)  

–ü—Ä–æ–±—Ä–æ—Å–∏–ª –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ —Ö–æ—Å—Ç –ø—Ä–∏ –ø–æ–º–æ—â–∏ **kubernetes-port-forwarder**  
![3.png placeholder](/documentation/img/hw-6/3.png)  

–ü–æ—Å–æ–∑–¥–∞–≤–∞–ª –Ω–∞–≥—Ä—É–∑–∫—É, –Ω–∞–±–ª—é–¥–∞–ª –¥—ç—à–±–æ—Ä–¥:  
![2.png placeholder](/documentation/img/hw-6/2.png)
